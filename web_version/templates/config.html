{% extends 'base.html' %}

{% block head %}
<title>SCVIS - Settings</title>
{% endblock %}

{% block body %}
<div id="settings" class="container border">
  <div class="header row">
    <div class="col pt-3 text-center">
      <h1>
        SCVIS - Settings
      </h1>
    </div>
    <div class="col-auto m-auto text-white">
      <a class="text-white" href="{{url_for('doc')}}" target="_blank">[Help]</a>
    </div>
  </div>
  <div class="row">
    <div id="status_area" class="col"></div>
  </div>
  <div class="settings_panel row">
    <div class="col">
      <div class="row">
        <div class="col">
          <textarea id="status_textarea" class="form-control w-100" style="height:80px" readonly></textarea>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a href="#select_channels" class="nav-link active" data-bs-toggle="tab">Select Channels</a>
            </li>
            <li class="nav-item">
              <a href="#select_sleep_stages" class="nav-link" data-bs-toggle="tab">Select Sleep Stages</a>
            </li>
            <li class="nav-item">
              <a href="#set_filters" class="nav-link" data-bs-toggle="tab">Set Filters</a>
            </li>
            <li class="nav-item">
              <a href="#set_epoch_size" class="nav-link" data-bs-toggle="tab">Set Epoch Size</a>
            </li>
          </ul>
          <div class="row">
            <div class="col">
              <form id="settings_form">
                <div class="tab-content border">
                  <div id="select_channels" class="tab-pane active">
                    <div class="row m-2">
                        <div class="col text-center">
                            <a id="select_all_or_none" class="btn btn-info" onclick="selectAllChannels(true);">Select All</a>
                        </div>
                    </div>
                    <div class="row m-2">
                      <div id="channels" class="col"></div>
                    </div>
                  </div>
                  <div id="select_sleep_stages" class="tab-pane">
                    <div class="row m-2">
                      <h5 class="text-center">
                        These are the events found in your EDF file. Please select those that are sleep stages.
                      </h5>
                    </div>
                    <div class="row m-2">
                      <div class="col" style="height: 530px;">
                        <div class="row bg-secondary bg-gradient" style="height:6%">
                          <div class="col m-auto text-center">
                            <span class="lead">All Annotations</span>
                          </div>
                        </div>
                        <div class="row" style="height:94%">
                          <div class="col overflow-auto border pt-1 pb-1 h-100">
                            <div id="annotations_relevant" class="border-bottom pb-1"></div>
                            <div id="annotations_nonrelevant" class="pt-1"></div>
                          </div>
                        </div>
                      </div>
                      <div class="col-auto">
                        <div class="row" style="height:6%">
                        </div>
                        <div class="row" style="height: 45%;">
                          <div class="col m-auto">
                            <div class="row">
                              <div class="col-auto p-1 text-center">
                                <a class="btn btn-primary" onclick="moveAnnotsToRightPanel();">&gt;&gt;</a>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col-auto p-1 text-center">
                                <a class="btn btn-primary" onclick="moveAnnotsToLeftPanel();">&#60;&#60;</a>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="row"></div>
                      </div>
                      <div class="col">
                        <div class="row bg-secondary bg-gradient" style="height:6%">
                          <div class="col m-auto text-center">
                            <span class="lead">Assigned Annotations</span>
                          </div>
                        </div>
                        <div class="row border border-1" style="height:45%;">
                          <div class="col">
                            <div class="row">
                              <div class="col">
                                <select id="sleep_stages" class="form-select w-100" onchange="showSleepStageAnnots(value, event);">
                                  {% for i in range(sleep_stages|length) %}
                                    {% if i == 0 %}
                                    <option value="{{ sleep_stages[i] }}" selected>{{ sleep_stages[i] }}</option>
                                    {% else %}
                                    <option value="{{ sleep_stages[i] }}">{{ sleep_stages[i] }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                              </div>
                            </div>
                            <div class="row ps-3 pe-3">
                              <div id="annotations_selected" class="col overflow-auto pt-1" style="height:80%"></div>
                            </div>
                          </div>
                        </div>
                        <div class="row mt-2 border border-1 text-center" style="height:48%">
                          <span class="m-2">The following events are assigned to the sleep stages</span>
                          <div class="col overflow-auto" style="height:80%">
                            <table class="table table-bordered table-responsive-md text-center" style="font-size:0.7em">
                              <thead>
                                <tr>
                                  <td style="width:25%">SLEEP STAGES</td>
                                  <td>SELECTED ANNOTATIONS</td>
                                </tr>
                              </thead>
                              <tbody>
                                {% for i in range(sleep_stages|length) %}
                                <tr>
                                  <td style="vertical-align:middle">{{sleep_stages[i]}}</td>
                                  <td id="st_annot_td_{{sleep_stages[i]}}"></td>
                                </tr>
                                {%endfor%}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="set_filters" class="row tab-pane m-2">
                    <div class="col">
                      <div class="row border border-light m-1">
                        <div class="col-9">
                          <label class="float-end" for="notch_freq_entry">Notch filter frequency (Hz):</label>
                        </div>
                        <div class="col-3">
                          <input type="text" class="form-control form-control-sm" name="notch_freq_entry" value="{{filter_settings['notch']}}">
                        </div>
                      </div>
                      <div class="row border border-3">
                        <div class="col">
                          <div class="row">
                            <h5>Bandpass filter options</h5>
                          </div>
                          <div class="row border border-light m-1">
                            <div class="col-9">
                              <label class="float-end" for="bandpass_min_freq_entry">Minimum frequency (Hz):</label>
                            </div>
                            <div class="col-3">
                              <input type="text" class="form-control form-control-sm" name="bandpass_min_freq_entry" value="{{filter_settings['bandpass'][0]}}">
                            </div>
                          </div>
                          <div class="row border border-light m-1">
                            <div class="col-9">
                              <label class="float-end" for="bandpass_max_freq_entry">Maximum frequency (Hz):</label>
                            </div>
                            <div class="col-3">
                              <input type="text" class="form-control form-control-sm" name="bandpass_max_freq_entry" value="{{filter_settings['bandpass'][1]}}">
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row border border-light m-1">
                        <div class="col-9">
                          <label class="float-end" for="amplitude_max_entry">Maximum amplitude (micro Volt):</label>
                        </div>
                        <div class="col-3">
                          <input type="text" class="form-control form-control-sm" name="amplitude_max_entry" value="{{filter_settings['amplitude_max']}}">
                        </div>
                      </div>
                      <div class="row border border-3">
                        <div class="col">
                          <div class="row">
                            <h5>Flat signal filter options</h5>
                          </div>
                          <div class="row border border-light m-1">
                            <div class="col-9">
                              <label class="float-end" for="flat_signal_duration_entry">Duration (seconds):</label>
                            </div>
                            <div class="col-3">
                              <input type="text" class="form-control form-control-sm" name="flat_signal_duration_entry" value="{{filter_settings['flat_signal'][0]}}">
                            </div>
                          </div>
                          <div class="row border border-light m-1">
                            <div class="col-9">
                              <label class="float-end" for="freq_std_min_flat_entry">Minimum frequency standard deviation in flat signal duration:</label>
                            </div>
                            <div class="col-3">
                              <input type="text" class="form-control form-control-sm" name="freq_std_min_flat_entry" value="{{filter_settings['flat_signal'][1]}}">
                            </div>
                          </div>
                          <div class="row border border-light m-1">
                            <div class="col-9">
                              <label class="float-end" for="freq_std_min_epoch_entry">Minimum frequency standard deviation in an epoch:</label>
                            </div>
                            <div class="col-3">
                              <input type="text" class="form-control form-control-sm" name="freq_std_min_epoch_entry" value="{{filter_settings['flat_signal'][2]}}">
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row border p-1 mt-1 border-3">
                        <div class="col">
                          <div class="row">
                            <h5>Annotations to remove from consideration</h5>
                          </div>
                          <div class="row">
                            <div id="bad_annotations" class="col d-flex flex-column">
                              <div class="row flex-grow-1 border border-light overflow-auto">
                              {% for annot, checked in bad_annot_settings %}
                                <div class="row border border-light">
                                  <div class="col">
                                    <input class="form-check-input" type="checkbox" name="bad_annots_list" value="{{ annot }}" {{ checked }}>
                                    <label class="form-check-label ms-2" for="{{ annot }}">{{ annot }}</label>
                                  </div>
                                </div>
                              {% endfor %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="set_epoch_size" class="row tab-pane m-2">
                    <div class="col">
                      <div class="row">
                        <div class="col-md-9">
                          <label class="float-end" for="epoch_size">Epoch Size (Seconds):</label>
                        </div>
                        <div class="col-md-3">
                          <input type="text" class="form-control form-control-sm" name="epoch_size" value="{{epoch_size}}">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-3 mb-3">
    <div class="col text-center">
        <a class="btn btn-primary" onclick="saveSettings();">Save</a>
    </div>
  </div>
</div>
<script type="text/javascript">
  const job_id = "{{job_id}}";
  const sleep_stages = JSON.parse('{{ sleep_stages|tojson }}');
  var channel_settings = JSON.parse('{{ channel_settings|tojson }}');
  var annots_all_settings = JSON.parse('{{ annots_all_settings|tojson }}');
  var annots_right_settings = JSON.parse('{{ annots_right_settings|tojson }}');
  loadSettings();
</script>
{% endblock %}